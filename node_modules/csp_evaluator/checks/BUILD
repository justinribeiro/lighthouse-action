# Description: CSP Checks for CSP Evaluator.

load("//javascript/typescript:build_defs.bzl", "ts_library")
load("//tools/build_defs/js:rules.bzl", "js_library")
load("//testing/karma/builddefs:karma_web_test_suite.bzl", "karma_web_test_suite")

package_group(
    name = "csp_evaluator",
    packages = ["//javascript/security/csp/csp_evaluator/..."],
)

package(default_visibility = [":csp_evaluator"])

js_library(
    name = "all_checks",
    srcs = [],
    exports = [
        ":parser_checks",
        ":security_checks",
        ":strictcsp_checks",
    ],
)

ts_library(
    name = "checker",
    srcs = ["checker.ts"],
    deps = [
        "//javascript/security/csp/csp_evaluator:csp",
        "//javascript/security/csp/csp_evaluator:finding",
    ],
)

ts_library(
    name = "parser_checks",
    srcs = ["parser_checks.ts"],
    deps = [
        "//javascript/security/csp/csp_evaluator:csp",
        "//javascript/security/csp/csp_evaluator:finding",
    ],
)

ts_library(
    name = "security_checks",
    srcs = ["security_checks.ts"],
    deps = [
        "//javascript/security/csp/csp_evaluator:csp",
        "//javascript/security/csp/csp_evaluator:finding",
        "//javascript/security/csp/csp_evaluator:utils",
        "//javascript/security/csp/csp_evaluator/allowlist_bypasses:angular",
        "//javascript/security/csp/csp_evaluator/allowlist_bypasses:flash",
        "//javascript/security/csp/csp_evaluator/allowlist_bypasses:jsonp",
    ],
)

ts_library(
    name = "strictcsp_checks",
    srcs = [
        "strictcsp_checks.ts",
    ],
    deps = [
        "//javascript/security/csp/csp_evaluator:csp",
        "//javascript/security/csp/csp_evaluator:finding",
    ],
)

filegroup(
    name = "js_files",
    srcs = glob(["*.js"]),
)

filegroup(
    name = "test_files",
    testonly = 1,
    srcs = glob([
        "*_test.html",
        "*_test.ts",
        "*_test_dom.html",
    ]),
)

ts_library(
    name = "checks_test_lib",
    testonly = True,
    srcs = [
        "parser_checks_test.ts",
        "security_checks_test.ts",
        "strictcsp_checks_test.ts",
    ],
    deps = [
        ":checker",
        ":parser_checks",
        ":security_checks",
        ":strictcsp_checks",
        "//javascript/security/csp/csp_evaluator:csp",
        "//javascript/security/csp/csp_evaluator:finding",
        "//javascript/security/csp/csp_evaluator:parser",
        "//third_party/javascript/closure/array",
        "//third_party/javascript/closure/string",
        "//third_party/javascript/typings/jasmine",
    ],
)

karma_web_test_suite(
    name = "checks_tests",
    browsers = [
        "//testing/web/browsers:chrome-linux",
        "//testing/web/browsers:chrome-win7",
        "//testing/web/browsers:edge-windows",
        "//testing/web/browsers/ios:safari-iphone-stable",
        "//testing/web/browsers/v63_0:firefox-linux",
        "//testing/web/browsers/v85_0:firefox-win7",
    ],
    deps = [":checks_test_lib"],
)
